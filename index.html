
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FF9800">
    <title>Gemini AI ç†±é‡è¿½è¹¤å™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Chart.js (ç”¨æ–¼åœ–è¡¨) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ä½¿ç”¨ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .loading-dot {
            animation: bounce 1s infinite;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
        }
        /* å½ˆçª—èƒŒæ™¯ */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px); /* å¢åŠ èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
        }
        /* è‡ªè¨‚æ ¸å–æ–¹å¡Šæ¨£å¼ */
        .custom-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }
        /* éš±è— Scrollbar ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="app" class="max-w-xl mx-auto pb-24">
        <header class="mb-8 p-4 bg-white rounded-2xl shadow-lg border border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-extrabold text-blue-700 tracking-tight">ğŸ½ï¸ ç¾é£Ÿç†±é‡åˆ†æ</h1>
                    <p class="text-gray-500 text-sm font-medium">æ‚¨çš„ AI ç‡Ÿé¤Šç®¡ç†åŠ©æ‰‹ã€‚</p>
                </div>
                <button onclick="showProfileModal(true)" class="p-3 bg-gray-50 rounded-full hover:bg-blue-50 text-gray-600 hover:text-blue-600 transition shadow-sm border border-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </button>
            </div>
            
            <!-- ç™»å…¥ç‹€æ…‹å€å¡Š (åƒ…é¡¯ç¤ºæ­¡è¿è¨Šæ¯èˆ‡ç™»å‡º) -->
            <div id="authSection" class="border-t border-gray-100 pt-4 hidden">
                <div id="userInfo" class="flex items-center justify-between">
                    <span id="userDisplayName" class="text-sm font-bold text-gray-800">æ­¡è¿ï¼</span>
                    <button onclick="signOutUser()" class="text-xs font-medium text-red-500 hover:text-red-700 border border-red-100 px-3 py-1 rounded-full hover:bg-red-50 transition">ç™»å‡º</button>
                </div>
            </div>
        </header>

        <!-- å„€è¡¨æ¿å€å¡Š -->
        <section id="dashboardSection" class="mb-8 p-6 bg-white rounded-2xl shadow-lg border border-gray-100">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                </span>
                ä»Šæ—¥å„€è¡¨æ¿
            </h2>
            
            <!-- å‰©é¤˜ç†±é‡é¡¯ç¤º -->
            <div class="text-center mb-6 p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl border border-blue-100">
                <p class="text-sm font-medium text-blue-600 mb-1">ä»Šæ—¥å‰©é¤˜ç†±é‡</p>
                <p id="remainingCalories" class="text-5xl font-extrabold text-blue-800 tracking-tight">...</p>
                <div class="flex justify-center space-x-4 text-xs font-medium mt-4">
                    <span id="todayTotal" class="px-3 py-1 bg-white rounded-full shadow-sm text-red-500">å·²æ”å–: ...</span>
                    <span id="calorieTarget" class="px-3 py-1 bg-white rounded-full shadow-sm text-green-600">ç›®æ¨™: ...</span>
                </div>
            </div>

            <!-- ç†±é‡åœ–è¡¨ -->
            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">éå» 7 å¤©ç†±é‡è¶¨å‹¢</h3>
            <div id="chartContainer" class="relative h-56 w-full">
                <canvas id="calorieChart"></canvas>
            </div>
        </section>

        <!-- æª”æ¡ˆä¸Šå‚³å€å¡Š -->
        <section class="mb-8 p-6 bg-white rounded-2xl shadow-lg border-2 border-dashed border-blue-200 hover:border-blue-300 transition-colors">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">ç´€éŒ„æ–°çš„ä¸€é¤</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="document.getElementById('cameraInput').click()" 
                        class="w-full py-4 px-4 rounded-2xl font-bold text-white bg-blue-600 hover:bg-blue-700 transition duration-150 shadow-lg shadow-blue-200 flex flex-col items-center justify-center group">
                    <div class="bg-white/20 p-2 rounded-full mb-2 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                    </div>
                    é–‹å•Ÿç›¸æ©Ÿ
                </button>
                <button onclick="document.getElementById('fileInput').click()" 
                        class="w-full py-4 px-4 rounded-2xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150 shadow-lg shadow-indigo-200 flex flex-col items-center justify-center group">
                    <div class="bg-white/20 p-2 rounded-full mb-2 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    </div>
                    å¾ç›¸ç°¿é¸å–
                </button>
            </div>

            <input type="file" id="cameraInput" accept="image/*" capture="camera" class="hidden" onchange="previewImage(event)">
            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="previewImage(event)">

            <div id="imagePreviewContainer" class="mt-6 hidden relative group">
                <img id="imagePreview" class="rounded-2xl max-h-80 w-full object-cover shadow-md" alt="ä¸Šå‚³åœ–ç‰‡é è¦½">
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-4 rounded-b-2xl">
                    <p class="text-white text-sm font-medium">é è¦½åœ–ç‰‡</p>
                </div>
            </div>
            <button onclick="analyzeFood()" id="analyzeButton" 
                class="mt-6 w-full py-3.5 px-4 rounded-xl font-bold text-white bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 transition duration-150 shadow-lg shadow-green-200 disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95"
                disabled>
                é–‹å§‹ AI åˆ†æç†±é‡
            </button>
        </section>

        <!-- åˆ†æçµæœå€å¡Š -->
        <section id="resultsSection" class="mb-8 p-6 bg-white rounded-2xl shadow-lg border border-gray-100 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="mr-2">ğŸ“ AI åˆ†æçµæœ</span>
                <span id="loadingIndicator" class="hidden flex space-x-1">
                    <span class="loading-dot w-2 h-2 bg-blue-500 rounded-full"></span>
                    <span class="loading-dot w-2 h-2 bg-blue-500 rounded-full"></span>
                    <span class="loading-dot w-2 h-2 bg-blue-500 rounded-full"></span>
                </span>
            </h2>

            <div id="totalCaloriesDisplay" class="bg-blue-50 p-4 rounded-xl font-bold text-xl text-blue-800 mb-6 shadow-sm border border-blue-100 flex justify-between items-center hidden">
                <span>ç¸½ä¼°è¨ˆç†±é‡</span>
                <span class="text-2xl"><span id="totalCaloriesValue">0</span> <span class="text-sm font-normal text-blue-600">kcal</span></span>
            </div>

            <div id="analysisResult" class="space-y-3"></div>
            
            <div id="adviceContainer" class="mt-6 hidden">
                <button onclick="getNutritionalAdvice()" id="getAdviceButton" 
                    class="w-full py-3 px-4 rounded-xl font-bold text-white bg-purple-500 hover:bg-purple-600 transition duration-150 shadow-md disabled:opacity-50 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    å–å¾— AI ç‡Ÿé¤Šå»ºè­°
                </button>
                <div id="adviceResult" class="mt-3 hidden p-5 bg-purple-50 rounded-xl border border-purple-100 text-gray-700 leading-relaxed shadow-sm"></div>
            </div>
            <button onclick="saveMeal()" id="saveButton"
                class="mt-6 w-full py-3.5 px-4 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 transition duration-150 shadow-lg shadow-blue-200 disabled:opacity-50">
                å„²å­˜é€™é¤
            </button>
            <!-- *** æ–°å¢ï¼šåœ°é»è¼¸å…¥æ¬„ä½ *** -->
            <div class="mt-4 relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <span class="text-gray-400">ğŸ“</span>
                </div>
                <input type="text" id="mealLocation" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out" placeholder="åœ¨å“ªè£¡ç”¨é¤ï¼Ÿ (é¸å¡«)">
            </div>
            <p id="saveMessage" class="text-sm text-center mt-2 text-gray-500 h-5"></p>
        </section>

        <!-- æ­·å²è¨˜éŒ„å€å¡Š (å„ªåŒ–ç‰ˆ) -->
        <section class="p-6 bg-white rounded-2xl shadow-lg border border-gray-100">
            <div class="flex justify-between items-end mb-6">
                <h2 class="text-xl font-bold text-gray-800">ç”¨é¤è¨˜éŒ„</h2>
                <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-md">é¡¯ç¤ºæœ€è¿‘ 50 ç­†</span>
            </div>
            <div id="pastMealsList" class="space-y-1">
                <p id="historyLoading" class="text-center text-gray-500 py-4">è¼‰å…¥ä¸­...</p>
            </div>
        </section>
        
        <div id="messageBox" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-gray-800 text-white rounded-lg shadow-2xl hidden transition duration-300 z-50 flex items-center text-sm font-medium"></div>
    </div>

    <!-- å€‹äººè³‡æ–™å½ˆçª— (Modal) -->
    <div id="profileModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-md p-6 rounded-3xl shadow-2xl transform transition-all max-h-[90vh] flex flex-col overflow-hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-1">å€‹äººè³‡æ–™</h2>
            <p class="text-sm text-gray-500 mb-4">ç®¡ç†æ‚¨çš„å¸³è™Ÿèˆ‡èº«é«”æ•¸å€¼ã€‚</p>
            
            <div class="overflow-y-auto no-scrollbar flex-grow pr-1">
                
                <!-- Google ç™»å…¥å€å¡Š (ç§»è‡³æ­¤è™•) -->
                <div id="profileLoginSection" class="mb-6 bg-gray-50 p-4 rounded-2xl border border-gray-100">
                    <p class="text-sm text-gray-600 mb-3 font-medium">ç™»å…¥ä»¥åŒæ­¥é›²ç«¯è¨˜éŒ„ï¼š</p>
                    <button id="googleSignInButton" onclick="signInWithGoogle()" 
                            class="w-full py-2.5 px-4 rounded-xl font-bold text-white bg-gray-900 hover:bg-black transition duration-150 shadow-lg flex items-center justify-center transform active:scale-95">
                        <svg class="w-5 h-5 mr-2" fill="white" viewBox="0 0 48 48"><path d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"></path></svg>
                        ä½¿ç”¨ Google ç™»å…¥
                    </button>
                    <p id="googleSignInMessage" class="text-xs text-gray-400 text-center mt-2"></p>
                </div>

                <form id="profileForm" class="space-y-5">
                    <h3 class="text-sm font-bold text-gray-900 border-b pb-2">TDEE è¨ˆç®—è¨­å®š</h3>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">æš±ç¨±</label>
                        <input type="text" id="nickname" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition" placeholder="ä¾‹å¦‚ï¼šç¾é£Ÿå®¶å°ç‹">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">æ€§åˆ¥</label>
                            <select id="gender" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="male">ç”·æ€§</option>
                                <option value="female">å¥³æ€§</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">å¹´é½¡</label>
                            <input type="number" id="age" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="30">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">èº«é«˜ (cm)</label>
                            <input type="number" id="height" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="170">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">é«”é‡ (kg)</label>
                            <input type="number" id="weight" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="65">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">æ´»å‹•é‡</label>
                        <select id="activityLevel" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                            <option value="1.2">ä¹…å (è¾¦å…¬å®¤å·¥ä½œ)</option>
                            <option value="1.375">è¼•åº¦æ´»å‹• (æ¯é€±é‹å‹•1-3å¤©)</option>
                            <option value="1.55">ä¸­åº¦æ´»å‹• (æ¯é€±é‹å‹•3-5å¤©)</option>
                            <option value="1.725">é«˜åº¦æ´»å‹• (æ¯é€±é‹å‹•6-7å¤©)</option>
                            <option value="1.9">æ¥µåº¦æ´»å‹• (é«”åŠ›å‹å‹•)</option>
                        </select>
                    </div>
                    
                    <!-- Delete Account Section -->
                    <div id="deleteAccountSection" class="pt-6 mt-4 border-t border-gray-100 hidden">
                        <button type="button" onclick="deleteUserAccount()" class="w-full py-2 px-4 border border-red-200 text-red-600 bg-red-50 rounded-xl hover:bg-red-100 font-medium text-sm transition">
                            æ°¸ä¹…åˆªé™¤æˆ‘çš„å¸³è™Ÿ
                        </button>
                    </div>
                </form>
            </div>
            <div class="flex justify-end pt-6 space-x-3 bg-white mt-auto">
                <button type="button" id="closeProfileModalButton" class="py-2.5 px-5 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-medium transition">ç¨å¾Œ</button>
                <button type="button" onclick="saveUserProfile()" class="py-2.5 px-6 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg shadow-blue-200 transition">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- è³‡æ–™è¡çªå½ˆçª— (Modal) -->
    <div id="mergeModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-md p-6 rounded-3xl shadow-2xl">
            <div class="text-center mb-6">
                <div class="mx-auto bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">è³‡æ–™è¡çª</h2>
                <p class="text-gray-600 mt-2 text-sm">åµæ¸¬åˆ°æ­¤ Google å¸³è™Ÿå·²æœ‰é›²ç«¯è³‡æ–™ã€‚<br>æ‚¨å¸Œæœ›å¦‚ä½•è™•ç†ç›®å‰è£ç½®ä¸Šçš„æš«å­˜è¨˜éŒ„ï¼Ÿ</p>
            </div>
            <div class="space-y-3">
                <button type="button" onclick="overwriteWithAnonymousData()" class="w-full py-3 px-4 bg-green-600 text-white rounded-xl hover:bg-green-700 font-bold shadow-md flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path></svg>
                    ä¿ç•™æœ¬æ©Ÿè³‡æ–™ (è¦†è“‹é›²ç«¯)
                </button>
                <button type="button" onclick="discardAnonymousData()" class="w-full py-3 px-4 bg-white border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-bold flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    æ¨æ£„æœ¬æ©Ÿï¼Œè¼‰å…¥é›²ç«¯
                </button>
            </div>
        </div>
    </div>
    
    <!-- *** ä¿®æ”¹å¾Œçš„ç¾åŒ–ç·¨è¼¯é¤é»å½ˆçª— (Modal) *** -->
    <div id="editMealModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <!-- æ”¹ç‚ºç„¡ padding çš„å®¹å™¨ï¼Œä»¥ä¾¿åœ–ç‰‡æ»¿ç‰ˆ -->
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl transform transition-all max-h-[90vh] flex flex-col overflow-hidden relative">
            
            <!-- åœ–ç‰‡å€å¡Š (æ»¿ç‰ˆ) -->
            <div class="relative h-64 shrink-0 bg-gray-100">
                <img id="editMealImage" src="" alt="é¤é»åœ–ç‰‡" class="w-full h-full object-cover">
                <!-- æ¼¸å±¤é®ç½©ï¼Œè®“æ–‡å­—æ›´æ¸…æ¥š -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
                
                <!-- é—œé–‰æŒ‰éˆ• (æ‡¸æµ®å³ä¸Š) -->
                <button type="button" id="closeEditModalButton" class="absolute top-4 right-4 p-2 bg-black/30 hover:bg-black/50 backdrop-blur-md rounded-full text-white transition z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>

                <!-- æ¨™é¡Œ (é¡¯ç¤ºåœ¨åœ–ç‰‡å·¦ä¸‹) -->
                <div class="absolute bottom-0 left-0 p-6 w-full">
                     <h2 id="editMealTitleText" class="text-2xl font-bold text-white shadow-sm leading-tight truncate">é¤é»è©³æƒ…</h2>
                     <div class="flex items-center text-gray-200 text-sm mt-1" id="editMealDateDisplay">
                        <!-- æ—¥æœŸå°‡ç”± JS å¡«å…¥ -->
                     </div>
                </div>
            </div>
            
            <!-- å…§å®¹å€å¡Š (æœ‰ padding) -->
            <div class="flex-grow overflow-y-auto p-6 space-y-6 no-scrollbar bg-white">
                
                <!-- åœ°é»æ¬„ä½ -->
                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <label for="editMealLocation" class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">ç”¨é¤åœ°é»</label>
                    <div class="flex space-x-2">
                        <input type="text" id="editMealLocation" class="flex-grow bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="æ–°å¢åœ°é»...">
                        <button onclick="updateMealLocation()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold shadow-sm">æ›´æ–°</button>
                    </div>
                </div>

                <!-- é£Ÿç‰©ç´°é …åˆ—è¡¨ -->
                <div>
                    <div class="flex justify-between items-end mb-3">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">é£Ÿç‰©å…§å®¹ & ç†±é‡</h3>
                        <span class="text-[10px] text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">ä¾ç†±é‡æ’åº</span>
                    </div>
                    <div id="editItemsList" class="space-y-3">
                        <!-- JS å‹•æ…‹å¡«å…¥ -->
                    </div>
                </div>
            </div>
            
            <!-- åº•éƒ¨æŒ‰éˆ• -->
            <div class="p-4 border-t border-gray-100 bg-gray-50">
                <button type="button" onclick="deleteEntireMeal()" class="w-full py-3 px-4 bg-white border border-red-100 text-red-500 rounded-xl hover:bg-red-50 hover:text-red-700 font-bold transition shadow-sm">
                    åˆªé™¤æ•´ç­†è¨˜éŒ„
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK å¼•å…¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signInWithCredential, 
            signOut,
            updateProfile,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp, 
            setLogLevel, 
            getDoc, 
            setDoc, 
            orderBy,
            getDocs, 
            writeBatch,
            deleteDoc,
            where,
            updateDoc,
            limit // å¼•å…¥ limit ç”¨æ–¼åˆ†é /é™åˆ¶æ•¸é‡
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å…¨åŸŸè®Šæ•¸
        let db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // (å·²å¡«å…¥æ‚¨æä¾›çš„ Firebase å°ˆæ¡ˆè¨­å®š)
        const firebaseConfig = {
          apiKey: "AIzaSyCp5EOEhA00zAQ_eyTqPW3h6db8fLuApks",
          authDomain: "foodcc-47d21.firebaseapp.com",
          projectId: "foodcc-47d21",
          storageBucket: "foodcc-47d21.firebasestorage.app",
          messagingSenderId: "753714580843",
          appId: "1:753714580843:web:7557b8179c4367389ed02e",
          measurementId: "G-9V9LJ5Y751"
        };
        
        let allAnalyzedItems = [];
        let currentMealData = [];
        let currentImageBase64 = null; 
        let currentImageMimeType = null;
        let currentFileName = 'AIåˆ†æé¤é»'; 

        let userProfile = null;
        let dailyCalorieTarget = 2000;
        let todaysTotalCalories = 0;
        let myChart = null;

        let anonymousUserIdBeforeSignIn = null;
        let googleCredentialForMerge = null; 
        let mealSubscription = null; 
        let isHandlingConflict = false; 
        let currentEditingMealId = null; // *** æ–°å¢ï¼šç”¨æ–¼ç·¨è¼¯å½ˆçª— ***

        setLogLevel('Debug');

        // ==== è¼”åŠ©å‡½æ•¸ï¼šè¨Šæ¯æç¤º ====
        function showMessage(msg, isError = true) {
            const box = document.getElementById('messageBox');
            box.textContent = msg;
            box.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-6 py-3 text-white rounded-full shadow-2xl transition-all duration-300 z-50 font-bold flex items-center space-x-2 ${isError ? 'bg-red-600' : 'bg-gray-900'}`;
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 4000); 
        }

        // ==== è¼”åŠ©å‡½æ•¸ï¼šè™•ç† Firebase ç¶²åŸŸéŒ¯èª¤ ====
        function getFriendlyErrorMessage(error) {
            if ((error.message && error.message.includes('requests-from-referer') && error.message.includes('blocked')) || 
                error.code === 'auth/unauthorized-domain') {
                return `ç¶²åŸŸæœªæˆæ¬Šã€‚è«‹è‡³ Firebase Console æ–°å¢ Authorized Domainï¼Œæˆ–è‡³ Google Cloud Console æª¢æŸ¥ API Key çš„ Website restrictionsã€‚ç›®å‰ç¶²åŸŸï¼šã€${window.location.hostname}ã€‘`;
            }
            if (error.message && error.message.includes('The requested action is invalid')) {
                 return 'API Key è¨­å®šå—é™ã€‚è«‹è‡³ Google Cloud Consoleï¼Œå°‡ "foodcc-47d21.firebaseapp.com" åŠ å…¥ API Key çš„ç¶²ç«™é™åˆ¶æ¸…å–®ä¸­ï¼Œé€™æ˜¯ç™»å…¥è¦–çª—å¿…é ˆçš„ã€‚';
            }
            return error.message;
        }

        // ==== éš¨æ©Ÿé¡è‰²å‡½æ•¸ ====
        let colorHue = 0; 
        function getRandomColor() {
            colorHue = (colorHue + 40) % 360; 
            const saturation = 70 + Math.random() * 20; 
            const lightness = 50 + Math.random() * 10; 
            return `hsla(${colorHue}, ${saturation}%, ${lightness}%, 0.7)`;
        }

        // ==== åœ–ç‰‡å£“ç¸®å‡½æ•¸ ====
        function resizeImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1024;
                        const scaleSize = MAX_WIDTH / img.width;
                        let newWidth, newHeight;
                        if (img.width > MAX_WIDTH) {
                            newWidth = MAX_WIDTH;
                            newHeight = img.height * scaleSize;
                        } else {
                            newWidth = img.width;
                            newHeight = img.height;
                        }
                        canvas.width = newWidth;
                        canvas.height = newHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, newWidth, newHeight);
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        const mimeType = 'image/jpeg';
                        resolve({
                            base64: compressedBase64.split(',')[1],
                            mimeType: mimeType,
                            displayUrl: compressedBase64 
                        });
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        }

        // ==== Gemini API å‘¼å« (åœ–åƒ) ====
        async function callGeminiAPI(base64Image, mimeType) {
            const userQuery = "è«‹è©³ç´°åˆ†æé€™å¼µåœ–ç‰‡ä¸­çš„æ‰€æœ‰é£Ÿç‰©ã€‚æ‰€æœ‰é£Ÿç‰©åç¨±åš´æ ¼ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚åªå›å‚³ JSON æ ¼å¼çš„çµæœï¼Œä¸åŒ…å«ä»»ä½•èªªæ˜æˆ– Markdown èªæ³•ã€‚";
            const systemPrompt = "ä½ æ˜¯ä¸€ä½ç²¾æº–çš„ç‡Ÿé¤Šå­¸å®¶ã€‚æ ¹æ“šåœ–ç‰‡ï¼Œè­˜åˆ¥æ‰€æœ‰é£Ÿç‰©ã€‚é‡é»ï¼šæ‰€æœ‰é£Ÿç‰©åç¨±å¿…é ˆç¿»è­¯æˆç¹é«”ä¸­æ–‡ï¼ˆTraditional Chineseï¼‰ã€‚å°æ–¼æ¯å€‹é£Ÿç‰©ï¼Œä¼°ç®—å…¶åç¨±å’Œç¸½ç†±é‡ï¼ˆkcalï¼‰ä»¥åŠä¼°è¨ˆä»½é‡ï¼ˆä»¥å…¬å…‹ 'g' ç‚ºå–®ä½ï¼‰ã€‚";
            
            const apiKey = "AIzaSyCN7hEfzCMfN6WkCpo30MtAO_a-2FblCKo"; 
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    foodItems: {
                        type: "ARRAY",
                        description: "é£Ÿç‰©ç´°é …æ¸…å–®",
                        items: {
                            type: "OBJECT",
                            properties: {
                                name: { type: "STRING", description: "é£Ÿç‰©åç¨± (ç¹é«”ä¸­æ–‡)" },
                                estimated_calories: { type: "NUMBER", description: "ä¼°è¨ˆç†±é‡ (kcal)" },
                                estimated_quantity_g: { type: "NUMBER", description: "ä¼°è¨ˆä»½é‡ (g)" }
                            },
                            required: ["name", "estimated_calories", "estimated_quantity_g"]
                        }
                    }
                },
                required: ["foodItems"]
            };
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        {
                            inlineData: {
                                mimeType: mimeType, 
                                data: base64Image
                            }
                        }
                    ]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                },
            };
            
            const maxRetries = 3;
            let lastError = null;
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API éŒ¯èª¤ç‹€æ…‹ç¢¼: ${response.status}. è¨Šæ¯: ${errorBody.error.message}`);
                    }
                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) throw new Error("API å›å‚³çµæœçµæ§‹ä¸æ­£ç¢ºæˆ–ç‚ºç©ºã€‚");
                    return JSON.parse(jsonText);
                } catch (error) {
                    lastError = error;
                    console.error(`Gemini API å˜—è©¦ ${attempt} å¤±æ•—:`, error);
                    if (attempt < maxRetries) await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
            throw new Error(`Gemini API å‘¼å«å¤±æ•—ï¼Œå·²é‡è©¦ ${maxRetries} æ¬¡ã€‚æœ€å¾ŒéŒ¯èª¤: ${lastError.message}`);
        }
        
        // ==== Gemini API å‘¼å« (æ–‡å­—) ====
        async function callGeminiTextAPI(mealData) {
            if (!mealData || mealData.length === 0) {
                return "æ‚¨æ²’æœ‰å‹¾é¸ä»»ä½•é£Ÿç‰©ï¼Œç„¡æ³•æä¾›å»ºè­°ã€‚";
            }
            const mealJson = JSON.stringify(mealData);
            const userQuery = `é€™æ˜¯æˆ‘çš„ä¸€é¤é£Ÿç‰©æ¸…å–®ï¼š${mealJson}ã€‚è«‹æ ¹æ“šé€™å€‹æ¸…å–®ï¼Œç”¨ç¹é«”ä¸­æ–‡æä¾›ä¸€æ®µç°¡çŸ­ï¼ˆç´„ 2-3 å¥ï¼‰çš„ç‡Ÿé¤Šç¸½çµï¼Œä¸¦çµ¦å‡ºä¸€å€‹å…·é«”çš„æ”¹é€²å»ºè­°ã€‚`;
            const systemPrompt = "ä½ æ˜¯ä¸€ä½å‹å–„ä¸”é¼“å‹µäººå¿ƒçš„ç‡Ÿé¤Šå¸«ã€‚ä½ çš„å›è¦†æ‡‰è©²ç°¡æ½”ã€æ­£é¢ï¼Œä¸¦å°ˆæ³¨æ–¼å¹«åŠ©ä½¿ç”¨è€…åšå‡ºæ›´å¥åº·çš„é¸æ“‡ã€‚";
            
            const apiKey = "AIzaSyCN7hEfzCMfN6WkCpo30MtAO_a-2FblCKo"; 
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: userQuery }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "text/plain",
                },
            };
            
            const maxRetries = 3;
            let lastError = null;
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`Text API éŒ¯èª¤ç‹€æ…‹ç¢¼: ${response.status}. è¨Šæ¯: ${errorBody.error.message}`);
                    }
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Text API å›å‚³çµæœçµæ§‹ä¸æ­£ç¢ºæˆ–ç‚ºç©ºã€‚");
                    return text.trim();
                } catch (error) {
                    lastError = error;
                    console.error(`Gemini Text API å˜—è©¦ ${attempt} å¤±æ•—:`, error);
                    if (attempt < maxRetries) await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
            throw new Error(`Gemini Text API å‘¼å«å¤±æ•—ï¼Œå·²é‡è©¦ ${maxRetries} æ¬¡ã€‚æœ€å¾ŒéŒ¯èª¤: ${lastError.message}`);
        }

        // ==== UI æ ¸å¿ƒå‡½æ•¸ï¼šé è¦½åœ–ç‰‡ ====
        window.previewImage = async function(event) { 
            const input = event.target; 
            const preview = document.getElementById('imagePreview');
            const container = document.getElementById('imagePreviewContainer');
            const analyzeButton = document.getElementById('analyzeButton');

            currentImageBase64 = null;
            currentImageMimeType = null;
            allAnalyzedItems = [];
            currentMealData = [];

            if (input.files && input.files[0]) {
                const file = input.files[0];
                currentFileName = file.name.split('.')[0] || 'AIåˆ†æé¤é»'; 
                
                try {
                    const compressedData = await resizeImage(file);
                    preview.src = compressedData.displayUrl; 
                    container.classList.remove('hidden');
                    analyzeButton.disabled = false;
                    currentImageBase64 = compressedData.base64;
                    currentImageMimeType = compressedData.mimeType;
                    showMessage('åœ–ç‰‡å£“ç¸®å®Œæˆï¼', false);
                } catch (error) {
                    console.error("åœ–ç‰‡å£“ç¸®å¤±æ•—:", error);
                    showMessage("åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹å˜—è©¦å¦ä¸€å¼µåœ–ç‰‡ã€‚", true);
                    container.classList.add('hidden');
                    preview.src = '';
                    analyzeButton.disabled = true;
                }
            } else {
                container.classList.add('hidden');
                preview.src = '';
                analyzeButton.disabled = true;
            }
            
            document.getElementById('analysisResult').innerHTML = ''; 
            document.getElementById('totalCaloriesDisplay').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('saveButton').disabled = true;
            document.getElementById('saveMessage').textContent = '';
            document.getElementById('adviceContainer').classList.add('hidden');
            document.getElementById('adviceResult').classList.add('hidden');
            document.getElementById('adviceResult').innerHTML = '';
        }
        
        // ==== UI æ ¸å¿ƒå‡½æ•¸ï¼šåˆ†æé£Ÿç‰© ====
        window.analyzeFood = async function() {
            const analyzeButton = document.getElementById('analyzeButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultDiv = document.getElementById('analysisResult');
            const resultsSection = document.getElementById('resultsSection');
            
            document.getElementById('adviceContainer').classList.add('hidden');
            document.getElementById('adviceResult').classList.add('hidden');
            document.getElementById('adviceResult').innerHTML = '';

            if (!currentImageBase64 || !currentImageMimeType) {
                return showMessage('è«‹å…ˆä¸Šå‚³é£Ÿç‰©åœ–ç‰‡ä¸¦ç­‰å¾…å£“ç¸®å®Œæˆï¼');
            }
            
            analyzeButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            resultsSection.classList.remove('hidden');
            resultDiv.innerHTML = '<p class="text-center text-blue-500">AI æ­£åœ¨åˆ†æä¸­ï¼Œè«‹ç¨å€™...</p>';
            allAnalyzedItems = [];
            currentMealData = [];
            document.getElementById('totalCaloriesDisplay').classList.add('hidden');
            
            try {
                const analysisData = await callGeminiAPI(currentImageBase64, currentImageMimeType);
                
                if (!analysisData || !analysisData.foodItems || analysisData.foodItems.length === 0) {
                    resultDiv.innerHTML = '<p class="text-red-500">AI ç„¡æ³•è­˜åˆ¥åœ–ç‰‡ä¸­çš„é£Ÿç‰©ç´°é …ã€‚è«‹å˜—è©¦å¦ä¸€å¼µåœ–ç‰‡ã€‚</p>';
                    document.getElementById('saveButton').disabled = true;
                    return;
                }
                
                allAnalyzedItems = analysisData.foodItems;
                
                let html = allAnalyzedItems.map((item, index) => {
                    const calories = item.estimated_calories || 0;
                    return `
                        <div class="p-3 border border-gray-100 rounded-xl shadow-sm flex items-center bg-gray-50 space-x-3 hover:bg-white hover:shadow-md transition-all">
                            <input type="checkbox" id="item-${index}" 
                                   class="form-checkbox h-5 w-5 rounded text-blue-600 border-gray-300 focus:ring-blue-500 custom-checkbox" 
                                   data-index="${index}" 
                                   onchange="updateSelectedMealData()" 
                                   checked>
                            <label for="item-${index}" class="flex-grow cursor-pointer">
                                <p class="font-bold text-gray-700">${item.name} (${item.estimated_quantity_g} g)</p>
                                <p class="text-sm text-red-500 font-medium">${calories.toFixed(0)} kcal</p>
                            </label>
                        </div>
                    `;
                }).join('');
                
                resultDiv.innerHTML = html;
                updateSelectedMealData(); 
                
                document.getElementById('totalCaloriesDisplay').classList.remove('hidden');
                document.getElementById('saveButton').disabled = false;
                document.getElementById('adviceContainer').classList.remove('hidden'); 
                showMessage('åˆ†æå®Œæˆï¼è«‹å‹¾é¸æ‚¨åƒä¸‹çš„é£Ÿç‰©', false);
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-500">åˆ†æå¤±æ•—: ${getFriendlyErrorMessage(error)}</p>`;
                document.getElementById('saveButton').disabled = true;
            } finally {
                analyzeButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        // ==== UI æ ¸å¿ƒå‡½æ•¸ï¼šæ›´æ–°å‹¾é¸çš„é¤é»è³‡æ–™èˆ‡ç¸½ç†±é‡ ====
        window.updateSelectedMealData = function() {
            currentMealData = [];
            let totalCalories = 0;
            
            allAnalyzedItems.forEach((item, index) => {
                const checkbox = document.getElementById(`item-${index}`);
                if (checkbox && checkbox.checked) {
                    currentMealData.push(item);
                    totalCalories += (item.estimated_calories || 0);
                }
            });

            document.getElementById('totalCaloriesValue').textContent = totalCalories.toFixed(0);
            
            const nothingSelected = currentMealData.length === 0;
            document.getElementById('saveButton').disabled = nothingSelected;
            document.getElementById('getAdviceButton').disabled = nothingSelected;
        }

        // ==== UI æ ¸å¿ƒå‡½æ•¸ï¼šå–å¾— AI å»ºè­° ====
        window.getNutritionalAdvice = async function() {
             if (!currentMealData || currentMealData.length === 0) {
                return showMessage('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é£Ÿç‰©é …ç›®ã€‚');
            }
            const adviceButton = document.getElementById('getAdviceButton');
            const adviceResultDiv = document.getElementById('adviceResult');
            adviceButton.disabled = true;
            adviceResultDiv.classList.remove('hidden');
            adviceResultDiv.innerHTML = '<p class="text-center text-purple-500 animate-pulse">âœ¨ AI ç‡Ÿé¤Šå¸«æ­£åœ¨æ€è€ƒä¸­...</p>';
            try {
                const adviceText = await callGeminiTextAPI(currentMealData);
                adviceResultDiv.innerHTML = `<p class="text-gray-800">${adviceText.replace(/\n/g, '<br>')}</p>`;
            } catch (error) {
                adviceResultDiv.innerHTML = `<p class="text-red-500">å–å¾—å»ºè­°å¤±æ•—: ${getFriendlyErrorMessage(error)}</p>`;
            } finally {
                adviceButton.disabled = false;
            }
        }

        // ==== å€‹äººè³‡æ–™èˆ‡å„€è¡¨æ¿å‡½æ•¸ ====
        window.showProfileModal = function(allowClose = true) {
            document.getElementById('profileModal').classList.remove('hidden');
            if (allowClose) {
                document.getElementById('closeProfileModalButton').classList.remove('hidden');
            } else {
                document.getElementById('closeProfileModalButton').classList.add('hidden');
            }
        }
        
        function hideProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }
        
        function calculateTDEE(profile) {
            try {
                const { gender, age, height, weight, activityLevel } = profile;
                if (!age || !height || !weight || !activityLevel) return 2000;
                const h = parseFloat(height);
                const w = parseFloat(weight);
                const a = parseInt(age);
                let bmr;
                if (gender === 'male') {
                    bmr = (10 * w) + (6.25 * h) - (5 * a) + 5;
                } else {
                    bmr = (10 * w) + (6.25 * h) - (5 * a) - 161;
                }
                const tdee = bmr * parseFloat(activityLevel);
                return Math.round(tdee);
            } catch (e) {
                console.error("TDEE è¨ˆç®—å¤±æ•—:", e);
                return 2000; 
            }
        }
        
        function updateDashboardUI() {
            const remaining = dailyCalorieTarget - todaysTotalCalories;
            const remainingEl = document.getElementById('remainingCalories');
            remainingEl.textContent = remaining.toFixed(0);
            document.getElementById('todayTotal').textContent = `å·²æ”å–: ${todaysTotalCalories.toFixed(0)} kcal`;
            document.getElementById('calorieTarget').textContent = `ç›®æ¨™: ${dailyCalorieTarget.toFixed(0)} kcal`;
            
            if (remaining < 0) {
                remainingEl.classList.add('text-red-500');
                remainingEl.classList.remove('text-blue-800');
            } else {
                remainingEl.classList.remove('text-red-500');
                remainingEl.classList.add('text-blue-800');
            }
        }
        
        // ==== æ›´æ–°åœ–è¡¨ (å †ç–Šé•·æ¢åœ–) ====
        function updateChart(mealData) {
            const ctx = document.getElementById('calorieChart').getContext('2d');
            const labels = [];
            const mealsByDay = new Map(); // Map<DateString, Array<MealObject>>
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 6; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const dateString = d.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
                labels.push(dateString);
                mealsByDay.set(dateString, []); 
            }
            
            todaysTotalCalories = 0; 
            const todayString = today.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });

            mealData.forEach(meal => {
                if (meal.CreatedAt && meal.TotalCalories) {
                    const mealDate = meal.CreatedAt.toDate();
                    const mealDateString = mealDate.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
                    
                    if (mealsByDay.has(mealDateString)) {
                        mealsByDay.get(mealDateString).push(meal); 
                    }
                    
                    const mealDateOnly = new Date(mealDate);
                    mealDateOnly.setHours(0,0,0,0);
                    if (mealDateOnly.getTime() === today.getTime()) {
                        todaysTotalCalories += meal.TotalCalories;
                    }
                }
            });

            updateDashboardUI();

            const datasets = [];
            let maxMealsPerDay = 0; 
            mealsByDay.forEach(meals => {
                if (meals.length > maxMealsPerDay) maxMealsPerDay = meals.length;
            });

            for (let i = 0; i < maxMealsPerDay; i++) {
                const mealDataForThisLayer = [];
                labels.forEach(label => {
                    const mealsOnThisDay = mealsByDay.get(label);
                    if (mealsOnThisDay && mealsOnThisDay[i]) {
                        // é€™è£¡æˆ‘å€‘åªå­˜æ•¸å­—ï¼Œä½†åœ¨ tooltip æœƒç”¨ index å» mealsByDay æŸ¥åå­—
                        mealDataForThisLayer.push(mealsOnThisDay[i].TotalCalories);
                    } else {
                        mealDataForThisLayer.push(0); 
                    }
                });
                
                datasets.push({
                    label: `é¤é»`, // é è¨­æ¨™ç±¤ï¼ŒTooltip æœƒè¦†è“‹
                    data: mealDataForThisLayer,
                    backgroundColor: getRandomColor(),
                });
            }

            datasets.push({
                label: 'æ¯æ—¥ç›®æ¨™',
                data: labels.map(() => dailyCalorieTarget), 
                type: 'line',
                borderColor: 'rgba(239, 68, 68, 0.8)',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: false,
                borderWidth: 3,
                pointRadius: 0
            });

            // Tooltip Callback é‚è¼¯ï¼šä½¿ç”¨ dataIndex å’Œ datasetIndex å›æŸ¥é¤é»åç¨±
            const tooltipCallbacks = {
                label: function(context) {
                    if (context.dataset.type === 'line') {
                        return `${context.dataset.label}: ${context.parsed.y.toFixed(0)} kcal`;
                    }

                    const dateIndex = context.dataIndex;
                    const mealIndex = context.datasetIndex; // é€™è£¡å‡è¨­å †ç–Šé †åºå°æ‡‰ mealsByDay é™£åˆ—é †åº
                    const dateLabel = context.chart.data.labels[dateIndex];
                    const mealsForDay = mealsByDay.get(dateLabel);
                    
                    if (mealsForDay && mealsForDay[mealIndex]) {
                        const meal = mealsForDay[mealIndex];
                        return `${meal.Name || 'æœªå‘½åé¤é»'}: ${meal.TotalCalories.toFixed(0)} kcal`;
                    }
                    return `é¤é»: ${context.parsed.y.toFixed(0)} kcal`;
                }
            };

            if (myChart) {
                myChart.data.labels = labels;
                myChart.data.datasets = datasets;
                // å¿…é ˆæ›´æ–° options æ‰èƒ½è®“ tooltip callback æŠ“åˆ°æ–°çš„ mealsByDay é–‰åŒ…
                myChart.options.plugins.tooltip.callbacks = tooltipCallbacks;
                myChart.update();
            } else {
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, 
                        plugins: {
                            tooltip: {
                                callbacks: tooltipCallbacks
                            },
                            legend: {
                                display: false // éš±è—åœ–ä¾‹ï¼Œå› ç‚ºé¡è‰²æ˜¯éš¨æ©Ÿçš„
                            }
                        },
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true, beginAtZero: true }
                        }
                    }
                });
            }
        }

        // ==== Firestore äº’å‹•ï¼šå„²å­˜è³‡æ–™ (*** å·²ä¿®æ”¹ ***) ====
        window.saveMeal = async function() {
            if (!currentMealData || currentMealData.length === 0 || !currentImageBase64 || !currentImageMimeType) {
                return showMessage('è«‹å…ˆå®Œæˆé£Ÿç‰©åˆ†æä¸¦å‹¾é¸è‡³å°‘ä¸€å€‹é …ç›®ã€‚');
            }
            if (!db || !userId) {
                 return showMessage('Firebase å°šæœªåˆå§‹åŒ–æˆ–ä½¿ç”¨è€…æœªç™»å…¥ã€‚', true);
            }

            const saveButton = document.getElementById('saveButton');
            const saveMessage = document.getElementById('saveMessage');
            saveButton.disabled = true;
            saveMessage.textContent = 'è³‡æ–™å„²å­˜ä¸­...';

            try {
                const totalCalories = currentMealData.reduce((sum, item) => sum + (item.estimated_calories || 0), 0);
                
                // *** ä¿®æ”¹ï¼šç”¢ç”Ÿä»£è¡¨æ€§çš„é¤é»åç¨± ***
                let mealName;
                if (currentMealData.length > 0) {
                    mealName = currentMealData[0].name; // ä½¿ç”¨ç¬¬ä¸€å€‹é£Ÿç‰©çš„åç¨±
                    if (currentMealData.length > 1) {
                        mealName += ` ç­‰ ${currentMealData.length} é …`; // ä¾‹å¦‚: "è‰è“é¬†é¤… ç­‰ 3 é …"
                    }
                } else {
                    mealName = currentFileName; // å¾Œå‚™æ–¹æ¡ˆï¼Œä½¿ç”¨æª”æ¡ˆåç¨±
                }

                // *** æ–°å¢ï¼šè®€å–åœ°é»æ¬„ä½ ***
                const location = document.getElementById('mealLocation').value || '';
                
                const mealsCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/Meals`);
                
                const newMealRef = await addDoc(mealsCollectionRef, {
                    Name: mealName, // *** ä½¿ç”¨æ–°çš„ mealName ***
                    Location: location, // *** æ–°å¢æ­¤æ¬„ä½ ***
                    PhotoBase64: currentImageBase64,
                    PhotoMimeType: currentImageMimeType,
                    TotalCalories: totalCalories,
                    CreatedAt: serverTimestamp(),
                    UserId: userId,
                });

                const foodItemsCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/FoodItems`);
                for (const item of currentMealData) {
                    // *** æ–°å¢ï¼šè¨ˆç®—ä¸¦å„²å­˜æ¯å…¬å…‹ç†±é‡ ***
                    let calPerGram = 0;
                    if (item.estimated_quantity_g && item.estimated_quantity_g > 0) {
                        calPerGram = (item.estimated_calories || 0) / item.estimated_quantity_g;
                    }

                    await addDoc(foodItemsCollectionRef, {
                        Name: item.name,
                        CaloriesPerServing: item.estimated_calories,
                        Quantity: item.estimated_quantity_g,
                        CaloriesPerGram: calPerGram, // *** æ–°å¢æ­¤æ¬„ä½ ***
                        MealId: newMealRef.id, 
                        UserId: userId,
                    });
                }
                
                saveMessage.textContent = `æˆåŠŸå„²å­˜é¤é»: ${mealName}ï¼`;
                showMessage('é¤é»å„²å­˜æˆåŠŸï¼', false);
                
                currentMealData = [];
                allAnalyzedItems = [];
                currentImageBase64 = null;
                currentImageMimeType = null;
                currentFileName = 'AIåˆ†æé¤é»'; 
                document.getElementById('cameraInput').value = ''; 
                document.getElementById('fileInput').value = ''; 
                
                document.getElementById('imagePreviewContainer').classList.add('hidden');
                document.getElementById('imagePreview').src = '';
                document.getElementById('analyzeButton').disabled = true;
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('saveButton').disabled = true;
                document.getElementById('mealLocation').value = ''; // *** æ–°å¢ï¼šé‡ç½®åœ°é»æ¬„ä½ ***
                document.getElementById('saveMessage').textContent = '';
                document.getElementById('adviceContainer').classList.add('hidden');
                document.getElementById('adviceResult').classList.add('hidden');
                document.getElementById('adviceResult').innerHTML = '';
                document.getElementById('totalCaloriesDisplay').classList.add('hidden');

            } catch (error) {
                console.error("å„²å­˜å¤±æ•—:", error);
                const errorMsg = 'è³‡æ–™åº«å„²å­˜å¤±æ•—ã€‚';
                saveMessage.textContent = errorMsg;
                showMessage(`å„²å­˜å¤±æ•—ï¼${error.message}`);
                saveButton.disabled = false;
            }
        }

        // ==== Firestore äº’å‹•ï¼šè¼‰å…¥å€‹äººè³‡æ–™ ====
        async function loadUserProfile(user) {
            if (!db || !user) return;
            const profileDocRef = doc(db, `/artifacts/${appId}/users/${user.uid}/Profile`, 'data');
            
            try {
                const docSnap = await getDoc(profileDocRef);
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    document.getElementById('nickname').value = userProfile.nickname || user.displayName || '';
                    document.getElementById('gender').value = userProfile.gender || 'male';
                    document.getElementById('age').value = userProfile.age || '';
                    document.getElementById('height').value = userProfile.height || '';
                    document.getElementById('weight').value = userProfile.weight || '';
                    document.getElementById('activityLevel').value = userProfile.activityLevel || '1.2';
                    dailyCalorieTarget = calculateTDEE(userProfile);
                    updateDashboardUI();
                } else {
                    document.getElementById('nickname').value = user.displayName || '';
                    // åªæœ‰åœ¨æ˜¯åŒ¿åä½¿ç”¨è€…ä¸”æ²’æœ‰è³‡æ–™æ™‚æ‰è‡ªå‹•è·³å‡º
                    if (user.isAnonymous) {
                        // *** ä¿®æ”¹ï¼šå°‡ false æ”¹ç‚º trueï¼Œé¡¯ç¤ºã€Œç¨å¾Œã€æŒ‰éˆ• (å³ç•¥éæŒ‰éˆ•) ***
                        showProfileModal(true);
                    }
                    updateDashboardUI(); 
                }
            } catch (error) {
                console.error("è¼‰å…¥å€‹äººè³‡æ–™å¤±æ•—:", error);
                showMessage("è¼‰å…¥å€‹äººè³‡æ–™å¤±æ•—", true);
            }
        }

        // ==== Firestore äº’å‹•ï¼šå„²å­˜å€‹äººè³‡æ–™ ====
        window.saveUserProfile = async function() {
            if (!db || !userId) return showMessage("ä½¿ç”¨è€…æœªç™»å…¥", true);

            const profileData = {
                nickname: document.getElementById('nickname').value,
                gender: document.getElementById('gender').value,
                age: document.getElementById('age').value,
                height: document.getElementById('height').value,
                weight: document.getElementById('weight').value,
                activityLevel: document.getElementById('activityLevel').value,
            };

            if (!profileData.age || !profileData.height || !profileData.weight) {
                return showMessage("è«‹å¡«å¯«å¹´é½¡ã€èº«é«˜å’Œé«”é‡ã€‚", true);
            }

            const profileDocRef = doc(db, `/artifacts/${appId}/users/${userId}/Profile`, 'data');
            
            try {
                await setDoc(profileDocRef, profileData, { merge: true });
                
                if (auth.currentUser && !auth.currentUser.isAnonymous && profileData.nickname !== auth.currentUser.displayName) {
                    await updateProfile(auth.currentUser, { displayName: profileData.nickname });
                }
                
                userProfile = profileData;
                dailyCalorieTarget = calculateTDEE(userProfile);
                updateDashboardUI(); 
                updateAuthUI(auth.currentUser); // æ›´æ–° UI ä¸Šçš„æš±ç¨±
                
                if (myChart) { 
                    myChart.data.datasets.find(ds => ds.type === 'line').data = myChart.data.labels.map(() => dailyCalorieTarget);
                    myChart.update();
                }
                
                hideProfileModal();
                showMessage("å€‹äººè³‡æ–™å„²å­˜æˆåŠŸï¼", false);
            } catch (error) {
                console.error("å„²å­˜å€‹äººè³‡æ–™å¤±æ•—:", error);
                showMessage("å„²å­˜å€‹äººè³‡æ–™å¤±æ•—", true);
            }
        }

        // ==== Firestore äº’å‹•ï¼šè¨‚é–±æ‰€æœ‰è³‡æ–™ (è®€å– Base64 åœ–ç‰‡) ====
        // *** ä¿®æ”¹ï¼šåŠ å…¥æ—¥æœŸåˆ†çµ„èˆ‡æ•¸é‡é™åˆ¶ ***
        function subscribeToMealsAndData(uid) {
            if (!db || !uid) return;

            const mealsCollectionRef = collection(db, `/artifacts/${appId}/users/${uid}/Meals`);
            // é™åˆ¶åªå–æœ€è¿‘ 50 ç­†
            const q = query(mealsCollectionRef, orderBy("CreatedAt", "desc"), limit(50));
            
            const historyList = document.getElementById('pastMealsList');
            document.getElementById('historyLoading').classList.remove('hidden');
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                let html = '';
                if (snapshot.empty) {
                    historyList.innerHTML = '<div class="flex flex-col items-center justify-center py-8 text-gray-400"><svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path></svg><p>å°šç„¡ç”¨é¤è¨˜éŒ„ï¼Œå¿«å»æ–°å¢ä¸€é¤å§ï¼</p></div>';
                    updateChart([]); 
                    return;
                }

                const allMeals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                // è³‡æ–™å·²ç”± query æ’åºç‚º desc (æœ€æ–°åœ¨å‰)
                
                // æ—¥æœŸåˆ†çµ„é‚è¼¯
                let lastDateStr = '';
                const todayStr = new Date().toLocaleDateString('zh-TW');
                
                // å–å¾—æ˜¨å¤©çš„æ—¥æœŸå­—ä¸²
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toLocaleDateString('zh-TW');

                allMeals.forEach(meal => {
                    let mealDateStr = 'æœªçŸ¥æ—¥æœŸ';
                    let displayDate = 'æœªçŸ¥æ—¥æœŸ';
                    
                    if(meal.CreatedAt) {
                        const mealDate = meal.CreatedAt.toDate();
                        mealDateStr = mealDate.toLocaleDateString('zh-TW');
                        
                        if (mealDateStr === todayStr) {
                            displayDate = 'ä»Šå¤©';
                        } else if (mealDateStr === yesterdayStr) {
                            displayDate = 'æ˜¨å¤©';
                        } else {
                            displayDate = mealDateStr;
                        }
                    }
                    
                    // æ’å…¥æ—¥æœŸæ¨™é¡Œ
                    if (mealDateStr !== lastDateStr) {
                         html += `
                            <div class="sticky top-0 bg-gray-50/90 backdrop-blur-sm z-10 py-2 px-1 mt-4 mb-1">
                                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">${displayDate}</h3>
                            </div>
                         `;
                         lastDateStr = mealDateStr;
                    }

                    let imgSrc = 'https://placehold.co/100x100/A0BFFF/FFFFFF?text=No+Img';
                    if (meal.PhotoBase64 && meal.PhotoMimeType) {
                        imgSrc = `data:${meal.PhotoMimeType};base64,${meal.PhotoBase64}`;
                    }
                    
                    // *** ä¿®æ”¹ï¼šå„ªåŒ–å¡ç‰‡æ¨£å¼ ***
                    html += `
                        <button onclick="openEditModal('${meal.id}', '${imgSrc}', '${meal.Name}', '${mealDateStr}')" 
                                class="w-full text-left p-3 bg-white border border-gray-100 rounded-xl flex items-center space-x-4 shadow-sm hover:shadow-md hover:bg-blue-50 transition group relative overflow-hidden">
                            <div class="w-16 h-16 rounded-lg overflow-hidden flex-shrink-0 border border-gray-100 shadow-inner">
                                <img src="${imgSrc}" class="w-full h-full object-cover transform group-hover:scale-110 transition duration-300" />
                            </div>
                            <div class="flex-grow min-w-0">
                                <p class="font-bold text-gray-800 truncate text-sm group-hover:text-blue-700">${meal.Name || 'ç„¡æ¨™é¡Œé¤é»'}</p>
                                ${meal.Location ? `<p class="text-xs text-gray-500 truncate mt-0.5 flex items-center"><svg class="w-3 h-3 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>${meal.Location}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <span class="block text-lg font-extrabold text-gray-900 group-hover:text-blue-600">${meal.TotalCalories ? meal.TotalCalories.toFixed(0) : '?'}</span>
                                <span class="text-xs text-gray-400 font-medium">kcal</span>
                            </div>
                        </button>
                    `;
                });
                historyList.innerHTML = html;
                
                // æ›´æ–°åœ–è¡¨ (é€™è£¡ä»éœ€å‚³éæ‰€æœ‰è³‡æ–™ä»¥è¨ˆç®—æ­£ç¢ºçš„æ­·å²ï¼Œä½†ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡åªç”¨å‰50ç­†ç•«åœ–ï¼Œæˆ–è€…ä¿æŒå¾Œç«¯æŸ¥è©¢ä¸€è‡´)
                // ç‚ºäº†åœ–è¡¨æ­£ç¢ºæ€§ï¼Œç†æƒ³ä¸Šæ‡‰è©²åˆ†é–‹æŸ¥è©¢ï¼Œä½†åœ¨å‰ç«¯ç°¡å–®å¯¦ä½œä¸­ï¼Œé€™è£¡ä½¿ç”¨å–å›çš„è³‡æ–™æ›´æ–°
                updateChart(allMeals);

            }, (error) => {
                console.error("æ­·å²è³‡æ–™è¼‰å…¥å¤±æ•—:", error);
                historyList.innerHTML = '<p class="text-center text-red-500">æ­·å²è¨˜éŒ„è¼‰å…¥å¤±æ•—ã€‚</p>';
            });
            return unsubscribe; // å›å‚³å–æ¶ˆè¨‚é–±çš„å‡½æ•¸
        }
        
        // ==== *** æ–°å¢ï¼šç·¨è¼¯é¤é»åŠŸèƒ½å€å¡Š *** ====
        
        // 1. é–‹å•Ÿç·¨è¼¯å½ˆçª— (å·²ä¿®æ”¹ï¼šæ¥æ”¶æ¨™é¡Œèˆ‡æ—¥æœŸ)
        window.openEditModal = async function(mealId, imgSrc, title, dateStr) { 
            currentEditingMealId = mealId;
            const imgEl = document.getElementById('editMealImage');
            imgEl.src = imgSrc;
            
            // è¨­å®šæ¨™é¡Œæ–‡å­—
            document.getElementById('editMealTitleText').textContent = title || 'æœªå‘½åé¤é»';
            document.getElementById('editMealDateDisplay').textContent = dateStr || '';

            document.getElementById('editItemsList').innerHTML = '<div class="flex justify-center py-4"><span class="loading-dot w-2 h-2 bg-gray-400 rounded-full mx-1"></span><span class="loading-dot w-2 h-2 bg-gray-400 rounded-full mx-1"></span><span class="loading-dot w-2 h-2 bg-gray-400 rounded-full mx-1"></span></div>';
            document.getElementById('editMealModal').classList.remove('hidden');
            
            // è¼‰å…¥é¤é»åœ°é»
            document.getElementById('editMealLocation').value = ''; 
            try {
                const mealDocRef = doc(db, `/artifacts/${appId}/users/${userId}/Meals`, mealId);
                const mealSnap = await getDoc(mealDocRef);
                if (mealSnap.exists()) {
                    const data = mealSnap.data();
                    document.getElementById('editMealLocation').value = data.Location || '';
                    // å¦‚æœåˆ—è¡¨æ²’å‚³æ¨™é¡Œï¼Œé€™è£¡å†è£œä¸€æ¬¡
                    if(!title) document.getElementById('editMealTitleText').textContent = data.Name || 'æœªå‘½åé¤é»';
                }
            } catch (error) {
                console.error("è¼‰å…¥é¤é»åœ°é»å¤±æ•—:", error);
            }
            
            loadItemsForEdit(mealId);
        }

        // 2. é—œé–‰ç·¨è¼¯å½ˆçª—
        function closeEditModal() {
            currentEditingMealId = null;
            document.getElementById('editMealModal').classList.add('hidden');
        }

        // 3. è¼‰å…¥è©²é¤é»çš„é£Ÿç‰©ç´°é …
        async function loadItemsForEdit(mealId) {
            if (!db || !userId || !mealId) return;
            const itemsListDiv = document.getElementById('editItemsList');
            const itemsRef = collection(db, `/artifacts/${appId}/users/${userId}/FoodItems`);
            const q = query(itemsRef, where("MealId", "==", mealId));
            
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    itemsListDiv.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">æ‰¾ä¸åˆ°é£Ÿç‰©ç´°é …ã€‚</p>';
                    return;
                }
                
                // *** ä¿®æ”¹ï¼šå‰ç«¯æ’åº (ç†±é‡é«˜ -> ä½) ***
                let itemsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ä¾ç…§ CaloriesPerServing é™åºæ’åˆ—
                itemsData.sort((a, b) => (b.CaloriesPerServing || 0) - (a.CaloriesPerServing || 0));

                let html = '';
                itemsData.forEach(item => {
                    const name = item.Name || 'æœªçŸ¥é£Ÿç‰©';
                    const qty = item.Quantity || 0;
                    const cals = item.CaloriesPerServing || 0;
                    const calPerGram = item.CaloriesPerGram || 0; 
                    
                    html += `
                        <div class="p-4 border border-gray-200 rounded-xl bg-white shadow-sm space-y-3" id="edit-item-${item.id}">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-gray-800">${name}</p>
                                <button onclick="deleteMealItem('${item.id}')" class="text-gray-400 hover:text-red-500 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ä»½é‡ (g)</label>
                                    <div class="relative">
                                        <input type="number" id="qty-${item.id}" 
                                            value="${qty}" 
                                            class="w-full text-sm p-2 pl-2 pr-8 border border-gray-200 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                                            data-cal-per-gram="${calPerGram}"  
                                            oninput="recalculateItemCalories('${item.id}')">
                                        <span class="absolute right-3 top-2 text-xs text-gray-400">g</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ç†±é‡ (kcal)</label>
                                    <div class="relative">
                                        <input type="number" id="cals-${item.id}" 
                                               value="${cals.toFixed(0)}" 
                                               class="w-full text-sm p-2 pl-2 pr-8 border border-gray-200 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition font-bold text-gray-700">
                                        <span class="absolute right-3 top-2 text-xs text-gray-400">å¡</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button onclick="updateMealItem('${item.id}')" class="text-xs font-bold text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-3 py-1.5 rounded-lg transition">ç¢ºèªä¿®æ”¹</button>
                            </div>
                        </div>
                    `;
                });
                itemsListDiv.innerHTML = html;
                
            } catch (error) {
                console.error("è¼‰å…¥é£Ÿç‰©ç´°é …å¤±æ•—:", error);
                itemsListDiv.innerHTML = `<p class="text-red-500 text-sm">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
            }
        }
        
        // 4b. *** æ–°å¢ï¼šåœ¨ç·¨è¼¯æ™‚ï¼Œæ ¹æ“šä»½é‡è‡ªå‹•è¨ˆç®—ç†±é‡ ***
        window.recalculateItemCalories = function(itemId) {
            try {
                const qtyInput = document.getElementById(`qty-${itemId}`);
                const calsInput = document.getElementById(`cals-${itemId}`);
                
                const newQty = parseFloat(qtyInput.value);
                const calPerGram = parseFloat(qtyInput.dataset.calPerGram);
                
                if (isNaN(newQty) || isNaN(calPerGram)) {
                    // å¦‚æœè¼¸å…¥ç„¡æ•ˆï¼Œä¸è¦è¨ˆç®—
                    return;
                }
                
                const newCals = newQty * calPerGram;
                calsInput.value = newCals.toFixed(0);
            } catch (error) {
                console.error("ç†±é‡é€£å‹•è¨ˆç®—å¤±æ•—:", error);
            }
        }
        
        // 4c. æ›´æ–°å–®ä¸€é£Ÿç‰©ç´°é … (åŸ 4. æ›´æ–°)
        window.updateMealItem = async function(itemId) {
            if (!db || !userId) return;
            const newQty = parseFloat(document.getElementById(`qty-${itemId}`).value);
            const newCals = parseFloat(document.getElementById(`cals-${itemId}`).value);
            
            if (isNaN(newQty) || isNaN(newCals)) {
                return showMessage("ä»½é‡æˆ–ç†±é‡å¿…é ˆæ˜¯æœ‰æ•ˆçš„æ•¸å­—ã€‚");
            }

            // *** æ–°å¢ï¼šé‡æ–°è¨ˆç®—ä¸¦å„²å­˜æ¯å…¬å…‹ç†±é‡ ***
            let newCalPerGram = 0;
            if (newQty && newQty > 0) {
                newCalPerGram = newCals / newQty;
            }
            
            const itemDocRef = doc(db, `/artifacts/${appId}/users/${userId}/FoodItems`, itemId);
            try {
                await updateDoc(itemDocRef, {
                    Quantity: newQty,
                    CaloriesPerServing: newCals,
                    CaloriesPerGram: newCalPerGram // *** æ–°å¢ï¼šæ›´æ–°æ­¤æ¬„ä½ ***
                });
                showMessage("é£Ÿç‰©ç´°é …å·²æ›´æ–°ï¼", false);
                // æ›´æ–°å®Œæˆå¾Œï¼Œé‡æ–°è¨ˆç®—æ•´é¤çš„ç¸½ç†±é‡
                await recalculateTotalCalories(currentEditingMealId);
            } catch (error) {
                console.error("æ›´æ–°ç´°é …å¤±æ•—:", error);
                showMessage("æ›´æ–°å¤±æ•—", true);
            }
        }
        
        // *** æ–°å¢ï¼šæ›´æ–°é¤é»åœ°é» ***
        window.updateMealLocation = async function() {
            if (!db || !userId || !currentEditingMealId) {
                return showMessage("ç„¡æ³•æ›´æ–°åœ°é»ï¼šæ‰¾ä¸åˆ°é¤é» ID æˆ–ä½¿ç”¨è€…ã€‚");
            }
            
            const newLocation = document.getElementById('editMealLocation').value;
            const mealDocRef = doc(db, `/artifacts/${appId}/users/${userId}/Meals`, currentEditingMealId);
            
            try {
                await updateDoc(mealDocRef, {
                    Location: newLocation
                });
                showMessage("åœ°é»å·²æ›´æ–°ï¼", false);
            } catch (error) {
                console.error("æ›´æ–°åœ°é»å¤±æ•—:", error);
                showMessage("æ›´æ–°åœ°é»å¤±æ•—", true);
            }
        }
        
        // 5. åˆªé™¤å–®ä¸€é£Ÿç‰©ç´°é …
        window.deleteMealItem = async function(itemId) {
            if (!db || !userId) return;
            
            const itemDocRef = doc(db, `/artifacts/${appId}/users/${userId}/FoodItems`, itemId);
            try {
                await deleteDoc(itemDocRef);
                showMessage("é£Ÿç‰©ç´°é …å·²åˆªé™¤ï¼", false);
                document.getElementById(`edit-item-${itemId}`).remove();
                // åˆªé™¤å®Œæˆå¾Œï¼Œé‡æ–°è¨ˆç®—æ•´é¤çš„ç¸½ç†±é‡
                await recalculateTotalCalories(currentEditingMealId);
            } catch (error) {
                console.error("åˆªé™¤ç´°é …å¤±æ•—:", error);
                showMessage("åˆªé™¤å¤±æ•—", true);
            }
        }
        
        // 6. é‡æ–°è¨ˆç®—è©²é¤é»çš„ç¸½ç†±é‡ (æ›´æ–°/åˆªé™¤ç´°é …å¾Œè§¸ç™¼)
        async function recalculateTotalCalories(mealId) {
            if (!db || !userId || !mealId) return;
            const itemsRef = collection(db, `/artifacts/${appId}/users/${userId}/FoodItems`);
            const q = query(itemsRef, where("MealId", "==", mealId));
            
            let newTotalCalories = 0;
            try {
                const snapshot = await getDocs(q);
                snapshot.docs.forEach(doc => {
                    newTotalCalories += (doc.data().CaloriesPerServing || 0);
                });
                
                // å°‡æ–°çš„ç¸½ç†±é‡å¯«å› Meals æ–‡ä»¶
                const mealDocRef = doc(db, `/artifacts/${appId}/users/${userId}/Meals`, mealId);
                await updateDoc(mealDocRef, {
                    TotalCalories: newTotalCalories
                });
                
                console.log(`é¤é» ${mealId} çš„ç¸½ç†±é‡å·²æ›´æ–°ç‚º ${newTotalCalories}`);
                // å„€è¡¨æ¿å’Œåœ–è¡¨æœƒå› ç‚º onSnapshot è‡ªå‹•æ›´æ–°
            } catch (error) {
                console.error("é‡æ–°è¨ˆç®—ç¸½ç†±é‡å¤±æ•—:", error);
            }
        }
        
        // 7. åˆªé™¤æ•´ç­†é¤é» (åŒ…å«æ‰€æœ‰ç´°é …)
        window.deleteEntireMeal = async function() {
            if (!db || !userId || !currentEditingMealId) return;
            
            const mealId = currentEditingMealId;
            
            const confirmDelete = confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†é¤é»è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚");
            if (!confirmDelete) return;

            try {
                const batch = writeBatch(db);
                
                // 1. åˆªé™¤ Meal æ–‡ä»¶
                const mealDocRef = doc(db, `/artifacts/${appId}/users/${userId}/Meals`, mealId);
                batch.delete(mealDocRef);
                
                // 2. æŸ¥è©¢ä¸¦åˆªé™¤æ‰€æœ‰ç›¸é—œçš„ FoodItems
                const itemsRef = collection(db, `/artifacts/${appId}/users/${userId}/FoodItems`);
                const q = query(itemsRef, where("MealId", "==", mealId));
                const itemsSnapshot = await getDocs(q);
                itemsSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                // 3. åŸ·è¡Œæ‰¹æ¬¡åˆªé™¤
                await batch.commit();
                
                showMessage("é¤é»å·²åˆªé™¤", false);
                closeEditModal();
                
            } catch (error) {
                console.error("åˆªé™¤æ•´ç­†é¤é»å¤±æ•—:", error);
                showMessage(`åˆªé™¤å¤±æ•—: ${error.message}`, true);
            }
        }
        
        // ==== *** çµæŸï¼šç·¨è¼¯é¤é»åŠŸèƒ½å€å¡Š *** ====

        // ==== Google ç™»å…¥ (å·²é‡æ§‹ï¼Œå¯è™•ç†è¦†è“‹) ====
        window.signInWithGoogle = async function() {
            // ç™»å…¥å‰ï¼Œè¨˜ä½ç•¶ä¸‹çš„åŒ¿å ID
            if (auth.currentUser && auth.currentUser.isAnonymous) {
                anonymousUserIdBeforeSignIn = auth.currentUser.uid;
            } else {
                anonymousUserIdBeforeSignIn = null;
            }

            const provider = new GoogleAuthProvider();
            const button = document.getElementById('googleSignInButton');
            const message = document.getElementById('googleSignInMessage');
            button.disabled = true;
            message.textContent = 'æ­£åœ¨é–‹å•Ÿ Google ç™»å…¥...';

            try {
                // åŠ å…¥ log ä»¥æ–¹ä¾¿é™¤éŒ¯
                console.log("Attempting Google Sign-In with Popup...");
                const result = await signInWithPopup(auth, provider);
                message.textContent = 'ç™»å…¥æˆåŠŸï¼';
                showMessage("Google ç™»å…¥æˆåŠŸï¼", false);
                
            } catch (error) {
                console.error("Google Sign-In Error Detail:", error); // è©³ç´° log
                
                // *** æ ¸å¿ƒï¼šæ•æ‰è¡çªéŒ¯èª¤ ***
                if (error.code === 'auth/credential-already-in-use' || error.code === 'auth/account-exists-with-different-credential') {
                    console.warn("åµæ¸¬åˆ°è³‡æ–™è¡çª:", error.code);
                    googleCredentialForMerge = GoogleAuthProvider.credentialFromError(error);
                    
                    // é¡¯ç¤ºåˆä½µå½ˆçª—
                    document.getElementById('mergeModal').classList.remove('hidden');
                    message.textContent = 'åµæ¸¬åˆ°è³‡æ–™è¡çª...';
                    
                } else {
                    console.error("Google ç™»å…¥å¤±æ•—:", error);
                    message.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
                    // ä½¿ç”¨å‹å–„éŒ¯èª¤è¨Šæ¯
                    showMessage(`ç™»å…¥å¤±æ•—: ${getFriendlyErrorMessage(error)}`, true);
                    button.disabled = false;
                    anonymousUserIdBeforeSignIn = null; 
                }
            }
        }
        
        // ==== ç™»å‡º ====
        window.signOutUser = async function() {
            try {
                await signOut(auth);
                showMessage("æ‚¨å·²æˆåŠŸç™»å‡ºã€‚", false);
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
                showMessage("ç™»å‡ºå¤±æ•—", true);
            }
        }
        
        // ==== æ›´æ–°ç™»å…¥ UI ====
        function updateAuthUI(user) {
            const userInfoDiv = document.getElementById('userInfo');
            const authSection = document.getElementById('authSection');
            const userDisplayName = document.getElementById('userDisplayName');
            const signInButton = document.getElementById('googleSignInButton');
            const signInMessage = document.getElementById('googleSignInMessage');
            const profileLoginSection = document.getElementById('profileLoginSection');
            const deleteSection = document.getElementById('deleteAccountSection');
            
            signInButton.disabled = false;

            if (user && !user.isAnonymous) {
                // å·²ç™»å…¥ Google å¸³è™Ÿ
                const displayName = userProfile?.nickname || user.displayName || user.email || 'å·²ç™»å…¥ä½¿ç”¨è€…';
                userDisplayName.textContent = `æ­¡è¿, ${displayName}!`;
                
                authSection.classList.remove('hidden'); // é¦–é é¡¯ç¤ºæ­¡è¿
                profileLoginSection.classList.add('hidden'); // Profile éš±è—ç™»å…¥æŒ‰éˆ•
                deleteSection.classList.remove('hidden'); // Profile é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            } else {
                // åŒ¿åç™»å…¥
                authSection.classList.add('hidden'); // é¦–é éš±è—æ­¡è¿ (æˆ–åªé¡¯ç¤ºåœ–ç¤ºï¼Œç”± header æœ¬èº«æ§åˆ¶)
                profileLoginSection.classList.remove('hidden'); // Profile é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
                signInMessage.textContent = 'ç™»å…¥ Google å¸³è™Ÿä»¥è·¨è£ç½®åŒæ­¥æ‚¨çš„è¨˜éŒ„ã€‚';
                deleteSection.classList.add('hidden'); // Profile éš±è—åˆªé™¤æŒ‰éˆ•
            }
        }

        // ==== è¼”åŠ©å‡½æ•¸ï¼šåˆªé™¤ä¸€å€‹ä½¿ç”¨è€…çš„æ‰€æœ‰è³‡æ–™ ====
        async function deleteAllUserData(uid) {
            if (!db || !uid) return;
            const batch = writeBatch(db);

            // åˆªé™¤ Meals
            const mealsRef = collection(db, `/artifacts/${appId}/users/${uid}/Meals`);
            const mealsSnapshot = await getDocs(mealsRef);
            mealsSnapshot.docs.forEach(doc => batch.delete(doc.ref));

            // åˆªé™¤ FoodItems
            const foodItemsRef = collection(db, `/artifacts/${appId}/users/${uid}/FoodItems`);
            const foodItemsSnapshot = await getDocs(foodItemsRef);
            foodItemsSnapshot.docs.forEach(doc => batch.delete(doc.ref));

            // åˆªé™¤ Profile
            const profileRef = doc(db, `/artifacts/${appId}/users/${uid}/Profile`, 'data');
            batch.delete(profileRef);

            await batch.commit();
            console.log(`å·²åˆªé™¤ä½¿ç”¨è€… ${uid} çš„æ‰€æœ‰è³‡æ–™ã€‚`);
        }
        
        // ==== æ–°å¢ï¼šåˆªé™¤ä½¿ç”¨è€…å¸³è™Ÿ ====
        window.deleteUserAccount = async function() {
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                showMessage("åªæœ‰å·²ç™»å…¥ Google çš„ä½¿ç”¨è€…æ‰èƒ½åˆªé™¤å¸³è™Ÿã€‚", true);
                return;
            }

            const confirmation = confirm("æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ‚¨çš„å¸³è™Ÿå’Œæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚");
            if (!confirmation) {
                return;
            }

            const user = auth.currentUser;
            const uid = user.uid;

            try {
                showMessage("æ­£åœ¨åˆªé™¤æ‚¨çš„è³‡æ–™...", false);
                await deleteAllUserData(uid);
                
                showMessage("è³‡æ–™å·²åˆªé™¤ï¼Œæ­£åœ¨åˆªé™¤å¸³è™Ÿ...", false);
                await deleteUser(user);
                
                hideProfileModal();
                showMessage("æ‚¨çš„å¸³è™Ÿå·²æˆåŠŸåˆªé™¤ã€‚", false);
                // onAuthStateChanged will automatically handle signing in a new anonymous user.
            } catch (error) {
                console.error("åˆªé™¤å¸³è™Ÿå¤±æ•—:", error);
                let message = `åˆªé™¤å¸³è™Ÿå¤±æ•—: ${error.message}`;
                if (error.code === 'auth/requires-recent-login') {
                    message = "æ­¤æ“ä½œéœ€è¦æ‚¨æœ€è¿‘æ›¾ç™»å…¥ã€‚è«‹å…ˆç™»å‡ºå†é‡æ–°ç™»å…¥ä¸€æ¬¡ï¼Œç„¶å¾Œå†å˜—è©¦åˆªé™¤ã€‚";
                }
                showMessage(message, true);
            }
        }

        // ==== è¼”åŠ©å‡½æ•¸ï¼šè¤‡è£½ä¸€å€‹ä½¿ç”¨è€…çš„æ‰€æœ‰è³‡æ–™åˆ°å¦ä¸€å€‹ ====
        async function copyUserData(fromUid, toUid) {
            if (!db || !fromUid || !toUid) return;
            const batch = writeBatch(db);
            const mealIdMap = new Map(); // å„²å­˜èˆŠ Meal ID å’Œæ–° Meal ID çš„å°æ‡‰

            // 1. è¤‡è£½ Profile
            const oldProfileRef = doc(db, `/artifacts/${appId}/users/${fromUid}/Profile`, 'data');
            const oldProfileSnap = await getDoc(oldProfileRef);
            if (oldProfileSnap.exists()) {
                const newProfileRef = doc(db, `/artifacts/${appId}/users/${toUid}/Profile`, 'data');
                batch.set(newProfileRef, oldProfileSnap.data());
            }

            // 2. è¤‡è£½ Meals
            const oldMealsRef = collection(db, `/artifacts/${appId}/users/${fromUid}/Meals`);
            const mealsSnapshot = await getDocs(oldMealsRef);
            
            for (const mealDoc of mealsSnapshot.docs) {
                const mealData = mealDoc.data();
                const newMealRef = doc(collection(db, `/artifacts/${appId}/users/${toUid}/Meals`));
                mealData.UserId = toUid; // æ›´æ–° UserId
                batch.set(newMealRef, mealData);
                mealIdMap.set(mealDoc.id, newMealRef.id); // è¨˜éŒ„ ID å°æ‡‰
            }

            // 3. è¤‡è£½ FoodItems
            const oldFoodItemsRef = collection(db, `/artifacts/${appId}/users/${fromUid}/FoodItems`);
            const foodItemsSnapshot = await getDocs(oldFoodItemsRef);
            
            for (const itemDoc of foodItemsSnapshot.docs) {
                const itemData = itemDoc.data();
                const newFoodItemRef = doc(collection(db, `/artifacts/${appId}/users/${toUid}/FoodItems`));
                itemData.UserId = toUid; // æ›´æ–° UserId
                // æ›´æ–°é—œè¯çš„ MealId
                if (itemData.MealId && mealIdMap.has(itemData.MealId)) {
                    itemData.MealId = mealIdMap.get(itemData.MealId);
                }
                batch.set(newFoodItemRef, itemData);
            }

            // 4. åŸ·è¡Œæ‰¹æ¬¡å¯«å…¥
            await batch.commit();
            console.log(`å·²å°‡ ${fromUid} çš„è³‡æ–™è¤‡è£½åˆ° ${toUid}`);
        }

        // ==== æ–°åŠŸèƒ½ï¼šä»¥æœ¬æ©Ÿè³‡æ–™è¦†è“‹é›²ç«¯ ====
        window.overwriteWithAnonymousData = async function() {
            if (!googleCredentialForMerge || !anonymousUserIdBeforeSignIn) {
                showMessage("è¦†è“‹å¤±æ•—ï¼šæ‰¾ä¸åˆ°æ†‘è­‰æˆ–åŒ¿å IDã€‚", true);
                return;
            }
            
            isHandlingConflict = true; 
            document.getElementById('mergeModal').classList.add('hidden');
            showMessage('è³‡æ–™è¦†è“‹ä¸­ï¼Œè«‹ç¨å€™...', false);
            
            try {
                // 1. å…ˆç”¨æ†‘è­‰ç™»å…¥ Google å¸³è™Ÿ
                const userCredential = await signInWithCredential(auth, googleCredentialForMerge);
                const newUserId = userCredential.user.uid;

                if (newUserId === anonymousUserIdBeforeSignIn) {
                    throw new Error("æ–°èˆŠ User ID ç›¸åŒï¼Œç„¡æ³•è¦†è“‹ã€‚");
                }
                
                // 2. åˆªé™¤ Google å¸³è™Ÿ (newUserId) ä¸Šçš„æ‰€æœ‰èˆŠè³‡æ–™
                showMessage('æ­£åœ¨åˆªé™¤é›²ç«¯èˆŠè³‡æ–™...', false);
                await deleteAllUserData(newUserId);
                
                // 3. è¤‡è£½åŒ¿åå¸³è™Ÿ (anonymousUserIdBeforeSignIn) çš„è³‡æ–™åˆ° Google å¸³è™Ÿ (newUserId)
                showMessage('æ­£åœ¨ä¸Šå‚³æœ¬æ©Ÿè³‡æ–™...', false);
                await copyUserData(anonymousUserIdBeforeSignIn, newUserId);
                
                showMessage('è³‡æ–™è¦†è“‹æˆåŠŸï¼æ­£åœ¨è¼‰å…¥æ‚¨çš„å¸³è™Ÿ...', false);
                
            } catch (error) {
                console.error("è³‡æ–™è¦†è“‹å¤±æ•—:", error);
                showMessage(`è³‡æ–™è¦†è“‹å¤±æ•—: ${error.message}`, true);
            } finally {
                // æ¸…é™¤æš«å­˜
                anonymousUserIdBeforeSignIn = null;
                googleCredentialForMerge = null;
                isHandlingConflict = false; 
                
                // å¼·åˆ¶ onAuthStateChanged é‡æ–°åŸ·è¡Œ
                onAuthStateChanged(auth, () => {});
                if(auth.currentUser) {
                    handleAuthStateChange(auth.currentUser);
                }
            }
        }

        // ==== æ‹‹æ£„è³‡æ–™å‡½æ•¸ (å·²ä¿®æ”¹) ====
        window.discardAnonymousData = async function() {
            if (!googleCredentialForMerge) {
                showMessage("æ“ä½œå¤±æ•—ï¼šæ‰¾ä¸åˆ°æ†‘è­‰ã€‚", true);
                return;
            }
            
            isHandlingConflict = true; 
            document.getElementById('mergeModal').classList.add('hidden');
            showMessage('å·²æ‹‹æ£„æœ¬æ©ŸåŒ¿åè³‡æ–™ï¼Œæ­£åœ¨ç™»å…¥...', false);

            try {
                // ç›´æ¥ç”¨æ†‘è­‰ç™»å…¥
                await signInWithCredential(auth, googleCredentialForMerge);
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
                showMessage(`ç™»å…¥å¤±æ•—: ${error.message}`, true);
            } finally {
                // æ¸…é™¤æš«å­˜
                anonymousUserIdBeforeSignIn = null;
                googleCredentialForMerge = null;
                isHandlingConflict = false;
                
                // å¼·åˆ¶ onAuthStateChanged é‡æ–°åŸ·è¡Œ
                onAuthStateChanged(auth, () => {});
                if(auth.currentUser) {
                    handleAuthStateChange(auth.currentUser);
                }
            }
        }

        // ==== æŠ½é›¢çš„ AuthStateChange è™•ç†å‡½æ•¸ ====
        async function handleAuthStateChange(user) {
            // å¦‚æœæ­£åœ¨è™•ç†è¡çªï¼Œå‰‡è·³é
            if (isHandlingConflict) {
                console.log("åµæ¸¬åˆ°è¡çªè™•ç†ä¸­ï¼ŒhandleAuthStateChange æš«åœ...");
                return;
            }

            // å–æ¶ˆèˆŠçš„è¨‚é–±
            if (mealSubscription) {
                mealSubscription();
                mealSubscription = null;
                document.getElementById('pastMealsList').innerHTML = '<div class="flex justify-center py-4"><span class="loading-dot w-2 h-2 bg-blue-400 rounded-full mx-1"></span><span class="loading-dot w-2 h-2 bg-blue-400 rounded-full mx-1"></span><span class="loading-dot w-2 h-2 bg-blue-400 rounded-full mx-1"></span></div>';
                document.getElementById('historyLoading').classList.remove('hidden');
            }
            
            let currentUser = user;
            if (!currentUser) {
                // å¦‚æœæ²’æœ‰ä½¿ç”¨è€… (ä¾‹å¦‚å‰›ç™»å‡º)ï¼Œå‰‡é‡æ–°åŒ¿åç™»å…¥
                try {
                    const userCredential = await signInAnonymously(auth);
                    currentUser = userCredential.user;
                } catch (anonError) {
                    console.error("åŒ¿åç™»å…¥å¤±æ•—:", anonError);
                    // ä½¿ç”¨å‹å–„éŒ¯èª¤è¨Šæ¯
                    showMessage(`ç„¡æ³•åŒ¿åç™»å…¥: ${getFriendlyErrorMessage(anonError)}`, true);
                    return;
                }
            }
            
            userId = currentUser.uid;
            console.log("Firebase èªè­‰æˆåŠŸï¼Œä½¿ç”¨è€… ID:", userId, "åŒ¿å:", currentUser.isAnonymous);
            
            updateAuthUI(currentUser);
            await loadUserProfile(currentUser);
            mealSubscription = subscribeToMealsAndData(userId); // å»ºç«‹æ–°è¨‚é–±
        }

        // ==== åˆå§‹åŒ– Firebase (å·²ä¿®æ”¹) ====
        async function initFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    console.error("Firebase è¨­å®šéºå¤±ï¼");
                    showMessage("Firebase è¨­å®šéºå¤±ï¼APP ç„¡æ³•é€£ç·šã€‚", true);
                    showProfileModal(false);
                    return; 
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ä½¿ç”¨æŠ½é›¢çš„å‡½æ•¸
                onAuthStateChanged(auth, handleAuthStateChange);

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                showMessage(`Firebase åˆå§‹åŒ–å¤±æ•—ï¼${getFriendlyErrorMessage(error)}`, true);
            }
        }
        
        // å°‡å¿…è¦çš„å‡½æ•¸æ›è¼‰åˆ° window
        window.saveUserProfile = saveUserProfile;
        window.showProfileModal = showProfileModal;
        window.updateSelectedMealData = updateSelectedMealData;
        window.signInWithGoogle = signInWithGoogle;
        window.signOutUser = signOutUser;
        window.overwriteWithAnonymousData = overwriteWithAnonymousData;
        window.discardAnonymousData = discardAnonymousData;
        window.deleteUserAccount = deleteUserAccount;
        window.openEditModal = openEditModal; 
        window.recalculateItemCalories = recalculateItemCalories; 
        window.updateMealItem = updateMealItem; 
        window.updateMealLocation = updateMealLocation; // *** æ–°å¢ ***
        window.deleteMealItem = deleteMealItem; 
        window.deleteEntireMeal = deleteEntireMeal; 
        document.getElementById('closeEditModalButton').onclick = closeEditModal; // *** æ–°å¢ ***
        // *** æ–°å¢ï¼šç‚ºã€Œå€‹äººè³‡æ–™ã€å½ˆçª—çš„ã€Œç¨å¾Œã€æŒ‰éˆ•ç¶å®šé—œé–‰äº‹ä»¶ ***
        document.getElementById('closeProfileModalButton').onclick = hideProfileModal;

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œåˆå§‹åŒ–
        window.onload = initFirebase;
    </script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          // *** ä¿®æ”¹ï¼šæ”¹ç‚ºç›¸å°è·¯å¾‘ './' è§£æ±º origin éŒ¯èª¤ ***
          navigator.serviceWorker.register('./service-worker.js')
            .catch(function(err) {
              console.error('Service Worker è¨»å†Šå¤±æ•—:', err);
            });
        });
      }
    </script>

</body>
</html>
